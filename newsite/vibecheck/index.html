<!DOCTYPE html>
<html><head>

    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <title>Victorian Validator</title>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Source+Sans+Pro&display=swap'); 
        html { font-family: "Times New Roman"; color: #212529; background-image: url("../twine/Agonies Assets/backgrounds/site background.png") }
        body { margin: 5em; margin-top: 1em; }
        div { display: flex; flex-direction: row; margin-top: 1em; }
        aside { background-color: #fff; height: fit-content; font-family: monospace; margin-right: 1em; padding: 1em; flex: 2; border: 1px dashed #000; box-shadow: 2px 2px #000;}
        main { background-color: #fff; padding: 3em; flex: 7; min-height: 80vh; border: 1px dashed #000; box-shadow: 3px 3px #000; }
        header { background-color: #fff; text-align: center; margin-left: auto; margin-right: auto; padding-top: 0.1em; padding-bottom: 0.1em; }
        em { font-style: normal }
        em.c { font-weight: bold; }
        em.f { font-style: italic; }
        em.r { text-decoration: underline; }
        button { border: 0; background-color: #684848; color: #fff; font-size: 1.25em; font-family: monospace; padding: 0.5em}
        button:hover { color: #000801b; }
        ul { text-align: center; list-style-type: none; padding: 0; margin: 0 }
        li { padding-top: 1em; text-decoration: underline solid; font-style: italic; }
        h2 { text-align: center; margin-top: 0 }
    </style>

    <script type="text/javascript" src="data.js">
        // Contains two variable, wcorp and qcorp. Each is a dictionary of lists where each key is a letter and a number. The letter is the first letter of the word, the number is the length of the word. This is to make it unnecessary to sort through the entire list.
        // wcorp's lists consist of a list of words (types) that appear in the corpus of letter novels.
        // qcorp consists of lists of two values: first, the number of tokens in quotes; second, the number of tokens in total.
        // The values in wcorp and qcorp have the same index in the same key, so finding the index in wcorp finds the index in qcorp.
        // This should be faster than just checking if every token is in a dictionary's keys, hence the roundabout method.
        // Also contains a list of stopwords.
    </script>
    <script>

        var tl = [144595, 96962, 89346, 58946, 49703, 46245, 43693, 41135, 38300, 36195, 32723, 31238, 29586, 28238, 27753, 26414, 25658, 24185, 22248, 20759, 20027, 18963, 17846, 17060, 15768, 15038, 14108, 13130, 12147, 11678, 10763, 10324, 9461, 9097, 8526, 8070, 7585, 7298, 6859, 6565, 6227, 5888, 5631, 5220, 4969, 4732, 4485, 4247, 3989, 3733, 3545, 3288, 3122, 2932, 2771, 2640, 2504, 2364, 2215, 2100, 1979, 1872, 1775, 1681, 1584, 1493, 1398, 1320, 1244, 1149, 1078, 1018, 951, 883, 823, 767, 710, 649, 597, 550, 504, 458, 418, 383, 346, 307, 275, 244, 215, 187, 160, 136, 115, 93, 74, 57, 39, 24, 10, 1]

        function stupidsort(x) {
          for (var i = 99; i > -1; i--) {
            if (tl[i] >= x) { break }}
          return i }

        // True if l is a letter, false otherwise. Had previously checked against a string of letters, which was inefficient.
        function isalpha(l) {
            var ccode = l.charCodeAt() 
            return ((96 < ccode && ccode < 123) || (64 < ccode && ccode < 91))}

        function clearinput() {
            let inpdiv = document.getElementById('input')
            if (inpdiv.contentEditable) {
                document.getElementById('input').innerText = '' }}

        function presetmenu() {
            let inpdiv = document.getElementById('input')
            inpdiv.contentEditable = false
            inpdiv.innerHTML = '<h2>Presets</h2><ul><li onclick="disp(0)">The Female Detective, by Andrew Forrester</li><li onclick="disp(1)">Mrs. Dalloway, by Virginia Woolf</li><li onclick="disp(2)">Doctor Faustus, by Christopher Marlowe</li><li onclick="disp(3)">The 14th c. Wycliffe Bible (with modernized spellings)</li><li onclick="disp(4)">Middlemarch, by Mary-Ann Evans</li><li onclick="disp(5)">Oliver Twist, by Charles Dickens</li><li onclick="disp(6)">United States Air Force Missile Guidance Training</li><li onclick="disp(7)">Moby-Dick, by Herman Melville</li><li onclick="disp(8)">English subtitles to Rashomon</li><li onclick="disp(9)">Ulysses, by James Joyce</li><li onclick="disp(10)">Snow Crash, by Neal Stephenson</li><li onclick="disp(11)">Wikipedia page on "Victorian Literature"</li><li onclick="disp(12)">Ada or Ardor, by Vladimir Nabokov</li><li onclick="disp(13)">Armadale, by Wilkie Collins</li></ul>' }

        function disp(i) {
            let inpdiv = document.getElementById('input')
            inpdiv.contentEditable = true
            inpdiv.innerText = sampleparagraphs[i] }

        // Breaks up the inputted text into parsable content.
        function process(text) {

            // setting: if setting is 0, the last character was not a letter; if it was a letter, it is 1.
            var ind = ['']; var setting = 0

            for (var i = 0; i < text.length; i++) {

                if (setting != isalpha(text[i])) {
                    ind.push('') 
                    setting = 1 - setting }

                ind[ind.length-1] += text[i] }

            return ind }

        // Evaluates each word by presence in the wordlist, whether it is rare, and whether it tends to be used as it is currently used (i.e. in or out of quotes).
        // If c is set to 1, just strips the text of formatting.
        function validate(c=0) {

            // Gets the text of the input field. Notably does not get the HTML so any existing tags are ignored; it will return HTML, not text.
            var text = document.getElementById('input').innerText

            // Normalizes newlines such that there are not more than two in a row. Then replaces them with the HTML.
            while (text.indexOf('\n\n\n') > -1) { text = text.replace(/\n\n\n/g,'\n\n') }

            if (!c) {

                var newtext = ''
                var indices = process(text) 
                overhue = []; for (var i = 0; i < 101; i++) { overhue.push(0) }

                for (var w = 0; w < Math.floor(indices.length/2); w++) { // Goes through each list of substring indices.

                    newtext += indices[w*2]
                    
                    var cut = indices[w*2+1]; var cap = false
                    if (cut[0] == cut[0].toUpperCase()) { cap = true }
                    cut = cut.toLowerCase()
                    let ins = ''

                    if (!(wordlookup[cut]) && !cap) {
                        ins = '<em class="f" data-rarity="'+100+'">'
                        overhue[100] += 1 }
                    else if (stopwords.indexOf(cut) == -1 && wordlookup[cut]) {
                        ssrar = stupidsort(wordlookup[cut])
                        overhue[ssrar] += 1
                        ins = '<em data-rarity="'+ssrar+'">' }
                    
                    if (ins.length) { newtext += ins + indices[w*2+1] + '</em>' }
                    else { newtext += indices[w*2+1] }}}

           newtext = newtext.replace(/\n/g,'<br>')
           document.getElementById('input').innerHTML = newtext // The text of the input has been converted into valid HTML.
           
            if (!c) {

               var hue = overhueval()
               document.getElementById('huescore').innerText = 'Score: '+Math.round(hue)+'%'
               hue = gradiant(1-hue/100)
               document.getElementById('huescore').style.backgroundColor = "rgb("+hue[0]+","+hue[1]+","+hue[2]+")"

               for (var emphasis of document.getElementsByTagName('em')) {
                   if (emphasis.className != 'f') { emphasis.addEventListener('click', inform) }
                   hue = gradiant(emphasis.dataset['rarity']/100)
                   if (emphasis.dataset['rarity'] != undefined) {
                       emphasis.style.color = 'rgb('+hue[0]+','+hue[1]+','+hue[2]+')' }}}}


        // Displays information upon clicking a token.
        function inform() {
               var word = this.innerText.toLowerCase() // Word must be lowercase as all words in wcorp are.
               var infobox = document.getElementById('info')
               document.getElementById('info').innerText = 'Word "'+word+'" appears '+wordlookup[word]+' times in the corpus and is thus in the top '+stupidsort(wordlookup[word])+'% of words.' }

        function gradiant(d,c=1,i=2) {
            var rgb = [0,0,0]
            if (!i) { rgb[c-1] = Math.floor(255*d) }
            else {
                if (d >= 0.5) {
                    rgb[c-1] = 255
                    rgb[i-1] = Math.floor(127*(1-2*(d-0.5)))
                } else {
                    rgb[i-1] = 255 - Math.floor(128*2*d)
                    rgb[c-1] = Math.floor(255*2*d)
            }} return rgb }

        function overhueval() {
            var points = 0
            var total = overhue.reduce(function (x,y) { return x+yÂ })
            var curtotal = 0
            for (i = 0; i < 100; i++) {
              curtotal += overhue[i]
              if (curtotal >= (total * (i+1) / 100)) { points += (total * (i+1) / 100)/curtotal }
              else { points += curtotal / (total * (i+1) / 100)}}
            return points }

    </script>

</head>

<body lang="en-US">

    <img src="logo.png" style="width: 15em;position: absolute;left: 1em;bottom: 1em;">
    <div>
        <aside>
            <button type="button" onclick="validate()">Evaluate</button><button type="button" onclick="clearinput()" style="margin-left: 0.25em">Clear</button><button type="button" onclick="presetmenu()" style="margin-left: 0.25em">Presets</button>
            <p>Regular: Ignored word.</p>
            <p><em data-rarity='0'>Colour 1:</em> Extremely common word.</p>
            <p><em data-rarity='50'>Colour 2:</em> Fairly common word.</p>
            <p><em data-rarity='100'>Colour 3:</em> Very uncommon word.</p>
            <p><em data-rarity='100' class='f'>Italicized</em>: word does not appear in the Victorian corpus.</p>
            <hr>
            <p id='info'>Clicking a valid word displays its use statistics here.</p>
            <hr>
            <div id='huescore' style='display: inline-block; padding: 0.5em; font-size: 1.25em; background-color: #684848; width: calc(100% - 1em); margin-top: 0; color: #fff; text-align: center'>Overall Score</div>
        </aside>

        <main contenteditable="true" id="input">
       </main>
    </div>

</body></html>
